# MigrateConfig

古いバージョンの設定オブジェクトを最新の形式に安全に変換（移行）するためのユーティリティです。設定構造の変更やプロパティ名の変更といった、後方互換性を損なう可能性のある更新を吸収し、アプリケーションの安定性を維持する役割を担います。

## 概要

アプリケーションのバージョンアップに伴い、設定（`config`）の構造が変更されることがあります。例えば、プロパティ名が変更されたり、新しい設定項目が追加されたりする場合です。`MigrateConfig` は、このような変更に対応するための一連の「移行ルール」を定義し、実行するための中核的な仕組みを提供します。

このモジュールは、現在の設定オブジェクトとデフォルト設定（`define`）を受け取り、定義済みの移行ルールを順番に評価・適用します。各ルールは、特定の条件（例：「古いプロパティが存在するか」）を満たす場合にのみ実行され、設定オブジェクトを安全に変更します。元の設定オブジェクトは変更せず、ディープコピーを作成して処理を行うため、副作用の心配がありません。

## 動作要件

このモジュールは、ネイティブの `Object.hasOwn()`（Chrome 93+、Firefox 92+）をサポートするブラウザで正しく動作します。

## 主な機能

- **安全な移行処理:** 元の設定オブジェクトを破壊しないよう、ディープコピーを作成して処理を行います。
- **ルールベースの移行:** 移行処理を個別の「ルール」として定義。各ルールは独立しており、追加や削除が容易です。
- **条件付き実行:** 各ルールは `condition` 関数を持ち、特定の条件を満たす場合にのみ移行処理 (`execute`) が実行されます。
- **堅牢なエラーハンドリング:** 特定のルールの実行中にエラーが発生しても、プロセス全体は停止しません。エラーはコンソールに出力され、該当ルールの適用はスキップされます。
- **適用履歴の追跡:** どの移行ルールが適用されたか、またどのルールでエラーが発生したかを記録し、結果として返すため、デバッグや確認が容易です。

## 設計思想

### 移行ルールの定義

`MigrateConfig` の中核は、`rules.ts` に定義された `migrationRules` 配列です。各ルールは、以下の3つの主要な要素で構成されます。

- **`rules` (メタデータ):**
  - 移行の理由、対象、変更内容などを記述するオブジェクト。この情報はデバッグやドキュメントとして利用され、実際の処理には影響しません。
  - 詳細は `MigrationRuleDefinition.md` を参照してください。

- **`condition(argument)` (条件関数):**
  - 移行を実行すべきかどうかを判断する関数です。`{ config, define }` を引数として受け取り、`boolean` 値を返します。
  - 例えば、「`config.Filtering` に `enable` プロパティが存在するか？」といったチェックを行います。

- **`execute(argument)` (実行関数):**
  - `condition` が `true` を返した場合にのみ実行される、移行処理の本体です。
  - `condition` と同様に `{ config, define }` を引数として受け取ります。
  - `config` オブジェクトを実際に変更し、新しい構造に変換します。変更後の `config` オブジェクトを返す必要があります。

この設計により、各移行ロジックは自己完結し、他のルールから独立して機能します。新しい設定変更が必要になった場合は、新しいルールオブジェクトを `migrationRules` 配列に追加するだけで対応できます。

### 実行プロセス

`migrateConfig` 関数が呼び出されると、以下のステップで処理が実行されます。

1.  **ディープコピー:** 入力された `config` と `define` オブジェクトのディープコピーを作成し、元のオブジェクトを保護します。
2.  **ルールの反復処理:** `migrationRules` 配列内の各ルールを順番に評価します。
3.  **条件の評価:** 各ルールについて `condition` 関数を実行し、移行が必要か判断します。
4.  **移行の実行:** `condition` が `true` を返した場合、`execute` 関数を実行して設定オブジェクトを変更します。
5.  **結果の集計:** すべてのルールの評価が終わった後、以下の情報を含むオブジェクトを返します。
    - `isSucceeded`: 全ての移行処理がエラーなく完了したかどうか。
    - `isExecuted`: いずれかのルールが実行されたかどうか。
    - `hasError`: 移行処理中にエラーが発生したか。
    - `appliedRules`: 適用されたルールのメタデータ配列。
    - `errorReports`: 発生したエラーの詳細情報配列。
    - `config`: 移行後の設定オブジェクト。

## 基本的な使い方

`migrateConfig` は、アプリケーションの起動時や設定読み込み時に使用することを想定しています。

```typescript
import { migrateConfig } from './MigrateConfig';
import { defaultConfig } from './path/to/defaultConfig'; // デフォルト設定
import { userConfig } from './path/to/userConfig';     // ユーザーが保存した設定

// ユーザー設定を移行
const result = migrateConfig(userConfig, defaultConfig);

if (result.isExecuted) {
  if (result.hasError) {
    console.error("設定の移行中にエラーが発生しました。", result.errorReports);
  } else {
    console.log("設定が移行されました。適用されたルール:", result.appliedRules);
    // 移行後の設定を保存するなどの処理
    saveConfig(result.config);
  }
} else {
  console.log("設定の移行は不要でした。");
}
```

## APIリファレンス

### `migrateConfig(config, define)`

設定オブジェクトを受け取り、定義された移行ルールに基づいて変換処理を実行します。

- **引数**:
  - **`config: Config`**: ユーザーが保存した、あるいは古いバージョンの設定オブジェクト。
  - **`define: Define`**: アプリケーションの最新のデフォルト設定オブジェクト。新しいプロパティのデフォルト値を参照するために使用されます。

- **戻り値**: `MigrationResult` オブジェクト
  - **`isSucceeded: boolean`**: 全ての移行処理がエラーなく完了した場合は `true`。
  - **`isExecuted: boolean`**: 少なくとも1つの移行ルールが実行された場合は `true`。
  - **`hasError: boolean`**: 移行処理中に1つ以上のエラーが発生した場合は `true`。
  - **`appliedRules: object[]`**: 適用された各ルールの `rules` メタデータを含む配列。
  - **`errorReports: object[]`**: 発生したエラー情報の配列。各要素には、問題のルール、エラーオブジェクト、その時点での設定が含まれます。
  - **`config: Config`**: 移行が適用された後の最終的な設定オブジェクト。

## 参考

- [MigrationRuleDefinition.ja.md](./MigrationRuleDefinition.ja.md) - 移行ルールの詳細な定義方法について。

## ライセンス

このプロジェクトは [MIT License](../../../../../../../LICENSE.md) の下で公開されています。
