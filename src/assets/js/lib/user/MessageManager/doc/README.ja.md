# PopoverMessage.ts

**最終更新日:** 2025年9月27日

Popover API を利用して、画面上にスタッカブルなメッセージを簡易的に表示するためのユーティリティクラスです。

---

## 概要

`PopoverMessage.create()` メソッドを呼び出すだけで、画面上にメッセージを手軽に表示できます。このクラスは、複数のメッセージを同時に管理し、新しいメッセージが上に積み重なるスタッカブルなUIを提供します。表示されたメッセージは、一定時間で自動的に消滅するほか、ユーザーがダブルクリックすることで能動的に閉じることも可能です。

このユーティリティは、インスタンスを必要としない静的クラス（ステートレス設計）として作られており、どのコンポーネントからでも簡単に呼び出すことができます。

## 主な機能

- **ステートレス設計:** インスタンス不要。すべての機能は静的メソッドを通じて提供されます。
- **シンプルなAPI:** 1つのメソッド呼び出しで、複雑な設定なしにメッセージを表示できます。
- **スタッカブルUI:** 複数のメッセージを縦に整列させて表示します。最大表示数（デフォルトで5件）を超えると、古いものから自動的に削除されます。
- **自動消滅と手動クローズ:** メッセージは指定時間で自動的に消えるほか、ダブルクリックで即座に閉じることができます。
- **柔軟なカスタマイズ:** メッセージの表示時間、フォントサイズ、色（文字・背景）を個別に設定可能です。
- **定義済みスタイル:** `success`, `debug`, `notice`, `warning`, `error` といった、一般的な用途に対応する5種類のメッセージタイプを標準で提供します。

## 基本的な使い方

以下に、基本的な使い方を示します。

```typescript
import { PopoverMessage } from './PopoverMessage';

// 最もシンプルな使い方
PopoverMessage.create({
  message: "処理が正常に完了しました。"
});

// 複数のメッセージとオプションを指定した例
PopoverMessage.create({
  message: [
    "警告: 必須項目が未入力です。",
    "フォームを再確認してください。"
  ],
  messagetype: "warning",
  timeout: 10000 // 10秒で消えるように設定
});

// 全てのオプションを指定した高度な使い方
PopoverMessage.create({
  message: "これは全てのオプションを指定したカスタムメッセージです。",
  timeout: 15000, // 15秒
  fontsize: "1.0rem", // rem単位での指定を推奨
  messagetype: "debug", // 'color'オプションで上書きされる
  color: {
    font: "white",
    background: "linear-gradient(45deg, #3a7bd5, #3a6073)"
  }
});
```

## APIリファレンス

### `PopoverMessage.create(options)`

画面上に新しいポップオーバーメッセージを表示します。

- **`options: PopoverMessageOptions`**: メッセージの表示設定を含むオブジェクト。

### `PopoverMessageOptions` インターフェース

`create` メソッドに渡す設定オブジェクトのインターフェースです。

```typescript
interface PopoverMessageOptions {
  /**
   * **必須**。表示するメッセージ文字列、またはその配列。
   * HTMLは解釈されず、プレーンテキストとして扱われます。
   */
  message: string | string[];

  /**
   * (任意) メッセージが自動で消えるまでの時間（ミリ秒）。
   * デフォルト: 5000
   */
  timeout?: number;

  /**
   * (任意) メッセージのフォントサイズ。
   * レスポンシブ対応のため、`rem`単位での指定を推奨します。
   * デフォルト: "1.0rem"
   */
  fontsize?: string;

  /**
   * (任意) メッセージの文字色と背景色を直接指定します。
   * この設定は `messagetype` よりも優先されます。
   */
  color?: {
    font?: string;
    background?: string;
  };

  /**
   * (任意) 定義済みのスタイルを適用します。
   * 'success' | 'debug' | 'notice' | 'warning' | 'error'
   */
  messagetype?: "success" | "debug" | "notice" | "warning" | "error";
}
```

## 動作仕様・注意事項

### メッセージの表示とスタック動作

- **表示位置:** 新しいメッセージは、画面の上部中央（`top: 20%`, `left: 50%`, `transform: translate(-50%, 0%)`）に固定で表示されます。
- **スタック:** 既にメッセージが表示されている場合、既存のメッセージは新しく表示されたメッセージの高さ分だけ、アニメーションしながら下方向にスライドします。
- **表示数の制限:** 同時に表示できるメッセージの最大数はデフォルトで5件に制限されています。この上限を超えて新しいメッセージが表示されると、最も古く表示されていたメッセージが自動的に非表示になり、DOMから削除されます。

### メッセージのテキスト形式

**`message` プロパティに渡される文字列にはHTMLを使用できません。**
このクラスは、内部で `textContent` プロパティに値を設定することで、渡された文字列をすべてプレーンテキストとして安全に扱います。HTMLタグを含む文字列を渡した場合、タグはHTML要素として解釈されず、画面上にそのままの文字列として表示されます（例: `<b>` は `<b>` と表示されます）。これはクロスサイトスクリプティング（XSS）を防ぐための意図的な設計です。

### レスポンシブデザイン

ポップオーバーメッセージの幅は、ビューポートの幅に応じて動的に調整されます。
- **最大幅:** `1024px` と `32rem` のうち小さい方
- **最小幅:** `256px` と `16rem` のうち大きい方
これにより、極端に広い画面や狭い画面でも、メッセージが適切なサイズで表示されるようになっています。

### 引数の検証

`create` メソッドに渡される引数は、内部で厳密に検証されます。
- **不正な引数:** `message` プロパティが存在しない、`timeout` が数値でないなど、予期しない型の引数が渡された場合、処理は中断され、ブラウザのコンソールにエラーメッセージが出力されます。
- **空のメッセージ:** `message` プロパティが空の文字列 (`""`) や空の配列 (`[]`) だった場合、処理は中断されませんが、代わりに「これは確認用メッセージです...」という内容の警告メッセージが自動的に表示されます。

### 依存API

このクラスは、以下のモダンブラウザAPIに依存しています。これらのAPIをサポートする環境で実行する必要があります。

- **Popover API:** ポップオーバーの基本的な表示・非表示機能に使用。
  - **Google Chrome**: `114` 以降
  - **Firefox**: `125` 以降
- **CSS Nesting:** スタイルシートの記述に使用。
  - **Google Chrome**: `112` 以降
  - **Firefox**: `117` 以降

詳細はMDNの各APIドキュメント（[Popover API](https://developer.mozilla.org/ja/docs/Web/API/Popover_API)、[CSS Nesting](https://developer.mozilla.org/ja/docs/Web/CSS/CSS_nesting)）を参照してください。

### 実行コンテキスト

このクラスは内部でDOM操作を行います。そのため、クライアントサイドのコンテキスト（Content Script、拡張機能のPopupページやOptionsページなど）での使用を想定しています。Background ScriptのようなDOMが存在しない環境では動作しません。

## ライセンス

このプロジェクトは [MIT License](../../../../../../../LICENSE.md) の下で公開されています。
