# QueueManager.ts

`p-queue` をカプセル化し、非同期タスクを管理・直列化するためのシングルトンクラスです。複数のタブを順番に開くといった処理を制御し、順序性を保証して競合状態を防ぐための中核コンポーネントです。

---

## 概要

ブラウザ拡張機能のような複雑なアプリケーションでは、一連の非同期処理（API呼び出しやタブのオープンなど）を管理することが極めて重要です。`QueueManager` は、このための堅牢で一元的なソリューションを提供します。直列実行ポリシー（`concurrency: 1`）を強制することで、タスクが予測可能な順序で一つずつ実行されることを保証します。

このユーティリティはシングルトンとして実装されており、アプリケーション全体でキューのインスタンスが一つだけ存在することを意味します。これにより、複数の競合するキューが作成されるのを防ぎ、すべての非同期タスクが単一の管理可能なチャネルを通じて処理されることを保証します。JavaScriptのPromiseを活用し、非同期操作を効率的に管理します。

## 動作要件

このモジュールは、ネイティブのPromiseサポート（Chrome 32+、Firefox 29+）、ECMAScriptのプライベートクラスフィールド（Chrome 74+、Firefox 68+）をサポートするブラウザで正しく動作します。

## 主な機能

- **シングルトン設計:** アプリケーション全体で単一の共有キューを保証し、非同期タスクの制御を一元化します。
- **直列実行:** タスクを一度に一つずつ実行することを保証し、競合状態を防ぎ、予測可能な実行順序を実現します。
- **優先度キュー:** 2段階の優先度システムをサポート。優先度の高いタスクを追加し、待機中の他の低優先度タスクよりも先に実行させることができます。
- **非プリエンプティブ:** タスクが一度実行を開始すると、新しい高優先度タスクが追加されても中断されることなく完了まで実行されます。優先度は、待機キュー内のタスクの順序にのみ影響します。
- **堅牢なカプセル化:** ECMAScriptのプライベートフィールド（`#`）を使用して内部の`p-queue`インスタンスを完全に隠蔽し、安全に制御されたメソッドのみを公開します。
- **ライフサイクル制御:** キューを `pause`（一時停止）、`resume`（再開）、`clear`（クリア）するメソッドを提供し、タスクフローのきめ細かな制御を可能にします。

## 設計思想

### 基盤ライブラリ: `p-queue` とその動作原理

`QueueManager` は、強力な `p-queue` ライブラリのラッパーです。その中核となる原則を理解することが、`QueueManager` を効果的に使用する鍵となります。

#### 1. タスクとタスク内の処理の分離

**タスク**と、その内部の**処理**との間には決定的な違いがあります。
- **タスク (Task):** `addTask()` や `addPriorityTask()` に渡される、Promiseを返す関数そのものです。`p-queue` はこの関数の実行を単一のユニットとして管理します。
- **タスク内の処理 (Operations):** タスクとして渡された関数の中で実行される具体的なコード（例：`for`ループ、複数の`await`呼び出しなど）です。

`p-queue`にとって、タスクは一種の**ブラックボックス**です。一度実行が開始されると、その内部でどれだけ多くの処理が行われようと、それが完了するまで関知しません。この「タスク」という単位をどう設計するか（＝**タスクの粒度**）が、効果的な「割り込み」のような高度な制御を実現する上で最も重要な要素となります。

#### 2. 基本的な動作モデル

`p-queue` は、内部的に2つの状態を保持しています。
- **待機キュー (Pending Queue):** 実行されるのを待っているタスクの場所です。
- **実行中 (Active/Running):** 現在実行されているタスクです。

`concurrency: 1` の設定では、常に1つのタスクしか「実行中」の状態になれず、残りはすべて「待機キュー」で待機します。

#### 3. 優先度と実行順序

タスクを追加する際に、優先度を割り当てることができます。`QueueManager` では、`addPriorityTask` が `addTask` よりも高い優先度を割り当てます。
- **数値が大きいほど高優先度**になります。
- 新しく優先度の高いタスクが追加されると、それは待機キューの中で、より低い優先度のタスクの**前に**挿入されます。

#### 4. 非プリエンプティブな性質

これが最も重要な特徴です：`p-queue` は **非プリエンプティブ（non-preemptive）** です。
- **実行中のタスクは中断されない:** たとえ後からより高い優先度のタスクが追加されたとしても、現在実行中のタスクは完了するまで中断されることはありません。
- **優先度が評価される瞬間:** 優先順位の評価は、実行中のタスクが完了し、待機キューから次に実行するタスクを選ぶ**瞬間**にのみ行われます。

### タスクの粒度

`QueueManager` の有効性は、追加されるタスクの「粒度」に大きく依存します。`addPriorityTask` メソッドが効果的な「割り込み」として機能するためには、他のタスクを最小の論理単位に分割する必要があります。

- **モノリシックなタスク（応答性が低いアプローチ）:** 100個のURLをループ処理する単一のタスクを追加した場合、その処理が完了するまでキューはブロックされます。このループ中に高優先度のタスクが追加されても、100個すべてのURLの処理が終わるまで待機する必要があり、緊急の要求に対するシステムの応答性が低下します。

- **粒度の細かいタスク（応答性が高いアプローチ）:** URLを開く処理を、例えば任意のサイズ（例：10個ずつ）のタスクに分割するか、あるいは各タスクが単一のURLを開くように個別のタスクとして追加した場合、それぞれのタスクの間にキューが他のタスクを実行する機会が生まれます。これにより、高優先度のタスクがシーケンスに「割り込む」チャンスが発生し、システム全体の応答性が大幅に向上します。

## 基本的な使い方

以下に、キューにタスクを追加する簡単な例を示します。

```typescript
import { QueueManager } from './QueueManager';
import { sleep } from '@/assets/js/utils/sleep'; // sleepユーティリティ関数を想定

console.log("キューにタスクを追加しています...");

// 標準（低優先度）タスクを追加
QueueManager.addTask(async () => {
  console.log("標準タスクが開始されました。");
  await sleep(1000);
  console.log("標準タスクが完了しました。");
});

// 別の標準タスクを追加
QueueManager.addTask(async () => {
  console.log("別の標準タスクが開始されました。");
  await sleep(1000);
  console.log("別の標準タスクが完了しました。");
});

// 高優先度タスクを追加。これは「別の標準タスク」よりも先に実行されます。
QueueManager.addPriorityTask(async () => {
  console.log("高優先度タスクが開始されました。");
  await sleep(500);
  console.log("高優先度タスクが完了しました。");
});

/*
期待されるコンソール出力:
"キューにタスクを追加しています..."
"標準タスクが開始されました。"
"標準タスクが完了しました。"
"高優先度タスクが開始されました。"
"高優先度タスクが完了しました。"
"別の標準タスクが開始されました。"
"別の標準タスクが完了しました。"
*/
```

## APIリファレンス

`QueueManager` はシングルトンインスタンスとしてエクスポートされます。

### `QueueManager.addTask(task)`

低優先度のタスクをキューに追加します。

- **`task: () => Promise<any>`**: 非同期関数、またはPromiseを返す関数。

### `QueueManager.addPriorityTask(task)`

高優先度のタスクをキューに追加します。このタスクは、待機中の他のどの低優先度タスクよりも先に実行されます。

- **`task: () => Promise<any>`**: 非同期関数、またはPromiseを返す関数。

### `QueueManager.clear()`

保留中（まだ開始されていない）のすべてのタスクをキューから削除します。

### `QueueManager.pause()`

キューを一時停止します。新しいタスクは開始されませんが、現在実行中のタスクは完了まで継続します。

### `QueueManager.resume()`

一時停止したキューを再開します。

### `QueueManager.isActive()`

保留中または実行中のタスクがあるかどうかを確認します。

- **戻り値**: `boolean` - キューのサイズまたは保留中の数がゼロより大きい場合は `true`、それ以外は `false`。

### `QueueManager.getPendingCount()`

実行を待っているタスクの数を取得します。

- **戻り値**: `number` - キュー内のタスク数。

### `QueueManager.getRunningCount()`

現在実行中のタスクの数を取得します。（`concurrency: 1` のため、常に `0` または `1` となります）。

- **戻り値**: `number` - 実行中のタスク数。

### `QueueManager.onIdle()`

キューが空になり、実行中のタスクがなくなったときに解決されるPromiseを返します。

- **戻り値**: `Promise<void>`

## 参考

- [p-queue (npm)](https://www.npmjs.com/package/p-queue)
- [p-queue (GitHub)](https://github.com/sindresorhus/p-queue)

## ライセンス

このプロジェクトは [MIT License](../../../../../../../LICENSE.md) の下で公開されています。
