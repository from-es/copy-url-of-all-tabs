# CompareVersions

**最終更新日:** 2025年10月8日

セマンティックバージョニング (SemVer) 形式のバージョン文字列を比較するためのユーティリティです。

---

## 概要

`compareVersions(base, target)` メソッドを呼び出すことで、2つのSemVer形式のバージョン文字列の大小関係を判断できます。このユーティリティは、[SemVer 2.0.0](https://semver.org/) の仕様に厳密に準拠しており、以下のフォーマットに基づいてバージョンを比較します。

**バージョンフォーマット: `MAJOR.MINOR.PATCH[-PRERELEASE][+BUILDMETADATA]`**

*   **`MAJOR` (メジャーバージョン):** 後方互換性のないAPIの変更があった場合に増分します。
*   **`MINOR` (マイナーバージョン):** 後方互換性のある機能追加があった場合に増分します。
*   **`PATCH` (パッチバージョン):** 後方互換性のあるバグ修正があった場合に増分します。
*   **`PRERELEASE` (プレリリース識別子):** ハイフン (`-`) の後に続く部分で、安定版ではないことを示します（例: `1.0.0-alpha.1`）。プレリリース版は、対応する通常版よりも優先度が低くなります。
*   **`BUILDMETADATA` (ビルドメタデータ):** プラス記号 (`+`) の後に続く部分で、ビルドに関する追加情報を示します（例: `1.0.0+build.123`）。ビルドメタデータはバージョンの優先度には影響しません。

このユーティリティは、メジャー、マイナー、パッチ、およびプレリリース識別子に基づいてバージョンを比較します。ビルドメタデータは比較に影響しません。

無効なバージョン文字列が引数として渡された場合、エラーがスローされます。

## 主な機能

- **SemVer 2.0.0 準拠:** セマンティックバージョニングの厳格なルールに従ってバージョンを比較します。
- **厳密な入力検証:** 入力されたバージョン文字列がSemVer形式に準拠しているかを詳細に検証します。文字列長、基本的なフォーマット、およびSemVer 2.0.0の仕様への適合性をチェックします。
- **プレリリース版の比較:** プレリリース識別子（例: `1.0.0-alpha`, `1.0.0-beta.1`）を含むバージョンの比較ルールを正確に処理します。
- **ビルドメタデータの無視:** ビルドメタデータ（例: `1.0.0+build.123`）はバージョンの優先度には影響しないため、比較時に無視されます。
- **自己完結型:** 外部ライブラリに依存せず、単独で機能します。

## 基本的な使い方

以下に、基本的な使い方を示します。

```typescript
import { compareVersions } from '../index'; // または './CompareVersions'

// target が base より大きい場合 (1.0.1 > 1.0.0)
const result1 = compareVersions("1.0.0", "1.0.1"); // 1

// target と base が等しい場合 (1.0.0 == 1.0.0)
const result2 = compareVersions("1.0.0", "1.0.0"); // 0

// target が base より小さい場合 (1.0.0 < 1.1.0)
const result3 = compareVersions("1.1.0", "1.0.0"); // -1

// プレリリース版の比較 (1.0.0-alpha < 1.0.0-alpha.1)
const result4 = compareVersions("1.0.0-alpha", "1.0.0-alpha.1"); // 1

// プレリリース版と安定版の比較 (1.0.0-alpha < 1.0.0)
const result5 = compareVersions("1.0.0-alpha", "1.0.0"); // 1

console.log(result1, result2, result3, result4, result5);
```

## APIリファレンス

### `compareVersions(base: unknown, target: unknown): CompareVersionsResult`

2つのセマンティックバージョニング形式のバージョン文字列を比較し、その大小関係を返します。

- **`base: unknown`**: 比較の基準となるバージョン文字列。
- **`target: unknown`**: 比較対象のバージョン文字列。
- **戻り値: `CompareVersionsResult` (`-1 | 0 | 1`)**:
    - `1`: `target` が `base` より大きい場合
    - `0`: `target` と `base` が等しい場合
    - `-1`: `target` が `base` より小さい場合
- **スローされるエラー**: 無効なバージョン文字列が渡された場合に `Error` をスローします。

### `SemVerString` 型

セマンティックバージョニング形式の文字列であることを示す Branded Type です。コンパイル時にのみ有効で、実行時には通常の `string` として扱われます。

### `CompareVersionsResult` 型

`compareVersions` 関数の戻り値の型で、`-1`, `0`, `1` のいずれかの数値です。

## 動作仕様・注意事項

### セマンティックバージョニング 2.0.0 準拠

このユーティリティは、[SemVer 2.0.0](https://semver.org/lang/ja/) の仕様に厳密に準拠してバージョンを比較します。特に、プレリリース版の比較ルールが正確に適用されます。ビルドメタデータは比較に影響しません。

SemVer 2.0.0の仕様では、プレリリース版の比較に関して以下のルールが定められています。

1.  **プレリリース識別子がないバージョンは、プレリリース識別子があるバージョンよりも優先度が高い。**
    *   例: `1.0.0` > `1.0.0-alpha`
2.  **プレリリース識別子があるバージョン同士の比較は、識別子をドットで区切って左から右へ比較する。**
3.  **識別子は、数値と文字列で異なるルールで比較される。**
    *   **数値識別子:** 数値として比較される。
        *   例: `1.0.0-alpha.1` < `1.0.0-alpha.2`
    *   **文字列識別子:** ASCII順序で比較される。
        *   例: `1.0.0-alpha` < `1.0.0-beta` (a < b)
    *   **数値と文字列の混在:** 数値識別子は文字列識別子よりも優先度が低い。
        *   例: `1.0.0-alpha.1` < `1.0.0-alpha.beta` (数値 < 文字列)
4.  **比較する識別子のフィールド数が異なる場合、共通のプレフィックスが同じであれば、フィールド数が多い方が優先度が高い。**
    *   例: `1.0.0-alpha` < `1.0.0-alpha.1`

このユーティリティは、これらのルールを厳密に適用してプレリリース版の比較を行います。

### 厳密な入力検証

`compareVersions` 関数に渡される引数は、内部で厳密に検証されます。
- **型検証:** `string` 型でない引数が渡された場合、エラーがスローされます。
- **文字列長:** バージョン文字列の長さが最大許容長（128文字）を超えた場合、エラーがスローされます。
- **フォーマット検証:** バージョン文字列がSemVer 2.0.0の仕様に準拠していない場合、エラーがスローされます。これには、ReDoS攻撃対策のための簡易的な正規表現チェックと、詳細なSemVer正規表現チェックが含まれます。

### エラーハンドリング

無効なバージョン文字列が `compareVersions` 関数に渡された場合、`Error` がスローされます。呼び出し元は `try...catch` ブロックを使用してこれらのエラーを適切に処理する必要があります。

### 実行コンテキスト

このユーティリティは純粋なロジック関数であり、DOM操作や特定のブラウザAPIに依存しません。そのため、クライアントサイド（Content Script、Popup、Optionsページなど）およびサーバーサイド（Node.js環境など）の両方で安全に使用できます。

## ライセンス

このプロジェクトは [MIT License](../../../../../../LICENSE.md) の下で公開されています。
